<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>765 MILLION ALLSTARS</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="css/bg.css">
    <link rel="stylesheet" href="css/page2.css">
    <style>
        h1 #title {
            color: #ffc30b;
            text-shadow: #ffc30b 0 0 15px;
        }

        h1 #title::after {
            background: linear-gradient(90deg, transparent, #ffc30b, transparent);
        }

        #imasRed:hover,
        #imasRed.active {
            background-color: #FF2384;
            color: #fefefe;
            box-shadow: 0 0 12px #FF2384;
        }

        #imasBlue:hover,
        #imasBlue.active {
            background-color: #005EFF;
            color: #fefefe;
            box-shadow: 0 0 12px #005EFF;
        }

        #imasYellow:hover,
        #imasYellow.active {
            background-color: #FFBB01;
            color: #fefefe;
            box-shadow: 0 0 12px #FFBB01;
        }
    </style>
</head>

<body>
    <img src="assets/img/ml10thanni.webp" alt="" id="bg" />
    <h1> <button id="title">765 MILLION ALLSTARS</button></h1>

    <div class="legend">
        <span class="legend-item"><span class="legend-color" style="background:#FF2384"></span>Princess</span>
        <span class="legend-item"><span class="legend-color" style="background:#005EFF"></span>Fairy</span>
        <span class="legend-item"><span class="legend-color" style="background:#FFBB01"></span>Angel</span>
    </div>

    <div id="chartWrapper">
        <!-- 模式切换 -->
        <div id="modeToggle">
            <button id="btn-radar" class="active">总体</button>
            <button id="btn-value">数值</button>
            <button id="btn-ratio">占比</button>
        </div>

        <!-- 雷达图 -->
        <div id="radarMode">
            <div id="radarChart"></div>
        </div>

        <!-- 数值模式 -->
        <div id="valueMode">
            <div id="barChartContainer">
                <div id="barChartBtns">
                    <button data-field="age" class="active">年龄</button>
                    <button data-field="height">身高(cm)</button>
                    <button data-field="weight">体重(kg)</button>
                    <button data-field="bust">胸围(cm)</button>
                    <button data-field="waist">腰围(cm)</button>
                    <button data-field="hip">臀围(cm)</button>
                    <button data-field="bmi">BMI</button>
                </div>
                <div id="barChart"></div>
                <div id="barChartStaticBtns">
                    <button id="btn-mean" class="active">平均值</button>
                    <button id="btn-med">中值</button>
                </div>
            </div>
        </div>

        <!-- 占比模式 -->
        <div id="ratioMode">
            <div id="pieChartContainer">
                <div id="prodBtns">
                    <button data-type="Princess" id="imasRed"
                        class="active"><span>P</span><span>r</span><span>i</span><span>n</span><span>c</span><span>e</span><span>s</span><span>s</span></button>
                    <button data-type="Fairy"
                        id="imasBlue"><span>F</span><span>a</span><span>i</span><span>r</span><span>y</span></button>
                    <button data-type="Angel"
                        id="imasYellow"><span>A</span><span>n</span><span>g</span><span>e</span><span>l</span></button>
                </div>
                <div id="distChart"></div>
                <div id="distBtns">
                    <button data-dist="age" class="active">年龄</button>
                    <button data-dist="height">身高</button>
                    <button data-dist="bust">胸围</button>
                    <button data-dist="hand">惯用手</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/title.js"></script>
    <script src="js/echarts.min.js"></script>
    <script>
        fetch('data/c@st.min.json')
            .then(res => res.json())
            .then(data => {
                const prodKey = ['THE IDOLM@STER', 'MILLION LIVE!'];
                const all = data.flatMap(p => p.staff.map(m => ({ ...m, production: p.production })));
                const arr = all.filter(m => prodKey.includes(m.production) && m.type !== '事务人员' && m.group !== '非可育成偶像');

                // 辅助函数
                const mean = a => a.length ? a.reduce((x, y) => x + y) / a.length : 0;
                const median = a => {
                    if (!a.length) return 0;
                    const s = a.slice().sort((x, y) => x - y);
                    const mid = Math.floor(s.length / 2);
                    return s.length % 2 ? s[mid] : (s[mid - 1] + s[mid]) / 2;
                };
                const std = (a, mu) => a.length ? Math.sqrt(a.reduce((s, v) => s + (v - mu) ** 2, 0) / a.length) : 0;

                const dims = ['age', 'height', 'weight', 'bust', 'waist', 'hip'];
                // 绘制雷达图
                const avgAll = dims.map(k => {
                    const vals = arr.map(m => (
                        k === 'bust' ? m.three_sizes?.[0]
                            : k === 'waist' ? m.three_sizes?.[1]
                                : k === 'hip' ? m.three_sizes?.[2]
                                    : m[k]
                    )).filter(v => v != null);
                    return mean(vals);
                });
                avgAll.forEach((v, i) => {
                    avgAll[i] = v.toFixed(2);
                });
                const radarChart = echarts.init(document.getElementById('radarChart'));
                radarChart.setOption({
                    title: { text: '平均属性', left: 'center', top: 15 },
                    textStyle: {
                        fontFamily: 'font-title', fontSize: 14
                    },
                    tooltip: {},
                    radar: {
                        shape: 'polygon', splitNumber: 5, center: ['50%', '55%'],
                        indicator: [
                            { name: '年龄', min: 15, max: 17.5 },
                            { name: '身高(cm)', min: 155, max: 160 },
                            { name: '体重(kg)', min: 40, max: 48.5 },
                            { name: '胸围(cm)', min: 79, max: 82 },
                            { name: '腰围(cm)', min: 53, max: 57 },
                            { name: '臀围(cm)', min: 78, max: 83 }
                        ],
                        axisName: { color: '#333' }
                    },
                    series: [{
                        name: '765 MILLION ALLSTARS', type: 'radar', data: [{
                            value: avgAll, areaStyle: { color: '#ffc30b', opacity: 0.3 }, itemStyle: { color: '#ffc30b' }, lineStyle: { color: '#ffc30b' }, label: {
                                show: true,
                                fontWeight: 'bold'
                            }
                        }]
                    }]
                });

                // 计算各 type 统计
                const types = ['Princess', 'Fairy', 'Angel'];
                const colors = { Princess: '#FF2384', Fairy: '#005EFF', Angel: '#FFBB01' };
                const typeStats = types.map(t => {
                    const sub = arr.filter(m => m.type === t);
                    const o = {};
                    dims.concat('bmi').forEach(k => {
                        let vals;
                        if (k === 'bmi') vals = sub.map(m => m.height && m.weight ? m.weight / ((m.height / 100) ** 2) : null);
                        else vals = sub.map(m => (
                            k === 'bust' ? m.three_sizes?.[0]
                                : k === 'waist' ? m.three_sizes?.[1]
                                    : k === 'hip' ? m.three_sizes?.[2]
                                        : m[k]
                        ));
                        vals = vals.filter(v => v != null);
                        o[k] = mean(vals);
                        o[`${k}_median`] = median(vals);
                        o[`${k}_std`] = std(vals, o[k]);
                    });
                    return o;
                });

                // 绘制柱状图
                const barChart = echarts.init(document.getElementById('barChart'));
                let field = 'age', mode = 'mean';
                const known = { 'age': '年龄', 'height': '身高(cm)', 'weight': '体重(kg)', 'bust': '胸围(cm)', 'waist': '腰围(cm)', 'hip': '臀围(cm)', 'bmi': 'BMI' };
                const mins = { 'age': 15, 'height': 150, 'weight': 40, 'bust': 75, 'waist': 50, 'hip': 75, 'bmi': 15 };
                function drawBar() {
                    const values = types.map((t, i) => mode === 'mean' ? typeStats[i][field] : typeStats[i][`${field}_median`]);
                    barChart.setOption({
                        title: { text: known[field], left: 'center', top: 10 },
                        textStyle: { fontFamily: 'font-title' },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => {
                                const idx = params.dataIndex;
                                const val = mode === 'mean' ? typeStats[idx][field] : typeStats[idx][`${field}_median`];
                                const sigma = typeStats[idx][`${field}_std`];
                                const modeLabel = mode === 'mean' ? 'μ' : 'Med';
                                return `${params.name}<br/>${params.marker}${modeLabel} = ${val.toFixed(2)}<br/>${params.marker}σ = ${sigma.toFixed(2)}`;
                            }
                        },
                        xAxis: { show: false, data: types },
                        yAxis: { type: 'value', min: mins[field] },
                        series: [{
                            type: 'bar',
                            data: values.map((v, i) => ({ value: v.toFixed(2), itemStyle: { color: colors[types[i]] } })),
                            barWidth: '50%',
                            label: { show: true, position: 'top', formatter: '{c}', fontWeight: 'bold' }
                        }]
                    });
                }
                document.querySelectorAll('#valueMode [data-field]').forEach(b => {
                    b.addEventListener('click', () => {
                        document.querySelectorAll('#valueMode [data-field]').forEach(x => x.classList.remove('active'));
                        b.classList.add('active');
                        field = b.getAttribute('data-field');
                        drawBar();
                    });
                });
                const btnMean = document.getElementById('btn-mean');
                const btnMed = document.getElementById('btn-med');
                btnMean.addEventListener('click', () => { mode = 'mean'; btnMed.classList.remove('active'); btnMean.classList.add('active'); drawBar(); });
                btnMed.addEventListener('click', () => { mode = 'median'; btnMean.classList.remove('active'); btnMed.classList.add('active'); drawBar(); });

                // 绘制饼图
                const pieChart = echarts.init(document.getElementById('distChart'));
                let selType = 'Princess', dist = 'age';
                const distBuckets = {
                    age: [['≤12岁', a => a <= 12], ['13-15岁', a => a <= 15], ['16-18岁', a => a <= 18], ['19-22岁', a => a <= 22], ['≥23岁', a => a > 22]],
                    height: [['≤149cm', h => h <= 149], ['150-156cm', h => h <= 156], ['157-162cm', h => h <= 162], ['163-169cm', h => h <= 169], ['≥170cm', h => h >= 170]],
                    bust: [['≤72cm', b => b <= 72], ['73-78cm', b => b <= 78], ['79-83cm', b => b <= 83], ['84-89cm', b => b <= 89], ['≥90cm', b => b >= 90]]
                };
                function drawPie() {
                    const subset = arr.filter(m => m.type === selType);
                    let data = [];
                    if (dist !== 'hand') {
                        const buckets = distBuckets[dist];
                        const counts = buckets.map(_ => 0);
                        subset.forEach(m => {
                            const v = dist === 'bust' ? m.three_sizes?.[0] : m[dist];
                            buckets.forEach(([, fn], i) => { if (fn(v)) counts[i]++; });
                        });
                        data = buckets.map((b, i) => ({ name: b[0], value: counts[i] })).filter(d => d.value > 0);
                    } else {
                        const hc = {};
                        subset.forEach(m => { if (m.handedness) hc[m.handedness] = (hc[m.handedness] || 0) + 1; });
                        data = Object.entries(hc).map(([k, v]) => ({ name: k, value: v }));
                    }
                    pieChart.setOption({
                        title: { text: known[field], left: 'center', top: 10 },
                        textStyle: { fontFamily: 'font-title', fontSize: 14 },
                        tooltip: {
                            trigger: 'item',
                            formatter: params => `${params.name}<br/>${params.marker}${params.value}人<br/>${params.marker}${params.percent}%`
                        },
                        legend: {
                            type: 'scroll',
                            orient: 'vertical',
                            left: 10,
                            top: 20,
                            bottom: 20,
                            data: data.map(d => d.name),
                        },
                        series: [{
                            type: 'pie', radius: '50%', data, selectedMode: 'multiple',
                            selectedOffset: 30, label: { formatter: '{b}（{d}%）' }
                        }]
                    });
                }
                document.querySelectorAll('#ratioMode [data-type]').forEach(b => {
                    b.addEventListener('click', () => {
                        document.querySelectorAll('#ratioMode [data-type]').forEach(x => x.classList.remove('active'));
                        b.classList.add('active');
                        selType = b.getAttribute('data-type');
                        drawPie();
                    });
                });
                document.querySelectorAll('#ratioMode [data-dist]').forEach(b => {
                    b.addEventListener('click', () => {
                        document.querySelectorAll('#ratioMode [data-dist]').forEach(x => x.classList.remove('active'));
                        b.classList.add('active');
                        dist = b.getAttribute('data-dist');
                        drawPie();
                    });
                });

                // 模式切换逻辑
                const modeButtons = document.querySelectorAll('#modeToggle button');
                function clearModeActive() { modeButtons.forEach(b => b.classList.remove('active')); }
                document.getElementById('btn-radar').addEventListener('click', () => {
                    clearModeActive(); document.getElementById('btn-radar').classList.add('active');
                    document.getElementById('radarMode').style.display = '';
                    document.getElementById('valueMode').style.display = 'none';
                    document.getElementById('ratioMode').style.display = 'none';
                });
                document.getElementById('btn-value').addEventListener('click', () => {
                    clearModeActive(); document.getElementById('btn-value').classList.add('active');
                    document.getElementById('radarMode').style.display = 'none';
                    document.getElementById('valueMode').style.display = '';
                    document.getElementById('ratioMode').style.display = 'none';
                    drawBar();
                });
                document.getElementById('btn-ratio').addEventListener('click', () => {
                    clearModeActive(); document.getElementById('btn-ratio').classList.add('active');
                    document.getElementById('radarMode').style.display = 'none';
                    document.getElementById('valueMode').style.display = 'none';
                    document.getElementById('ratioMode').style.display = '';
                    drawPie();
                });
                document.getElementById('btn-radar').click();
            });
    </script>
</body>

</html>